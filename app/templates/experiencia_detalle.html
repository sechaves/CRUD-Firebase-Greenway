{% extends "base.html" %}
{% block title %}{{ experiencia.nombre }}{% endblock %}

{% block styles %}
<style>
    .experiencia-imagen {
        height: 500px;
        object-fit: cover;
        border-radius: 15px;
    }
    .sidebar-reservas {
        position: sticky;
        top: 100px;
    }
    .precio-tag {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--greenway-primary);
    }
    .btn-contactar {
        background-color: var(--greenway-primary);
        border: none;
        color: white;
        font-weight: 600;
        padding: 12px 25px;
        font-size: 1.1rem;
        transition: all 0.3s;
    }
    .btn-contactar:hover {
        background-color: var(--greenway-accent);
        color: white;
        transform: translateY(-2px);
    }
    .map-container iframe {
        width: 100% !important;
        height: 100% !important;
        border-radius: 15px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
    
    {% if experiencia %}
    
    <div class="row mb-3">
        <div class="col-12">
            <h1 class="display-5 fw-bold">{{ experiencia.nombre }}</h1>
            
            <p class="lead text-muted">
                Anfitrión: <span class="fw-bold text-dark">{{ owner_name }}</span>
            </p>
        </div>
    </div>

    <div class="row g-5">
        
        <div class="col-lg-8">
            
            <div id="carouselExperiencia" class="carousel slide shadow-sm mb-4" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    {% for img in experiencia.imagenes %}
                        <button type="button" data-bs-target="#carouselExperiencia" 
                                data-bs-slide-to="{{ loop.index0 }}" 
                                class="{{ 'active' if loop.first else '' }}" 
                                aria-current="true"></button>
                    {% endfor %}
                </div>
                <div class="carousel-inner" style="border-radius: 15px;">
                    {% for img_url in experiencia.imagenes %}
                    <div class="carousel-item {{ 'active' if loop.first else '' }}">
                        <img src="{{ img_url }}" class="d-block w-100 experiencia-imagen" alt="Foto Experiencia">
                    </div>
                    {% else %}
                    <div class="carousel-item active">
                        <img src="https://via.placeholder.com/800x500.png?text=Sin+Imagen" class="d-block w-100 experiencia-imagen">
                    </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExperiencia" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carouselExperiencia" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                </button>
            </div>
            
            <hr class="my-4">
            <h2 class="fw-bold">Descripción</h2>
            <p class="fs-5" style="white-space: pre-wrap;">{{ experiencia.descripcion }}</p>

            {% if experiencia.maps_embed_url %}
                <hr class="my-4">
                <h2 class="fw-bold"><i class="bi bi-geo-alt-fill text-danger"></i> Ubicación</h2>
                <div class="ratio ratio-16x9 map-container shadow-sm mb-4">
                    {{ experiencia.maps_embed_url|safe }}
                </div>
            {% endif %}

        </div> 

        <div class="col-lg-4">
            <div class="sidebar-reservas">
                
                <div class="card shadow-sm border-0">
                    <div class="card-body p-4">
                        
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <span class="precio-tag">
                                ${{ "{:,.0f}".format(experiencia.precio_noche) }} COP
                            </span>
                            <span class="text-muted">/ noche</span>
                        </div>

                        {% if session['user_id'] %}
                            {% if session['user_id'] != experiencia.propietario_id %}
                                <a href="{{ url_for('chats', owner_id=experiencia.propietario_id, exp_id=experiencia_id) }}" 
                                   class="btn btn-contactar w-100 mb-3">
                                    <i class="bi bi-chat-text-fill me-2"></i> Contactar Anfitrión
                                </a>
                            {% else %}
                                <div class="alert alert-info text-center">
                                    <small>Eres el dueño de esta experiencia</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <a href="{{ url_for('login') }}" class="btn btn-secondary w-100 mb-3">
                                Inicia sesión para contactar
                            </a>
                        {% endif %}
                        
                        {% if session['role'] == 'admin' or (experiencia.propietario_id == session['user_id']) %}
                            <hr class="my-4">
                            <h5 class="text-muted mb-3 fs-6">Administrar</h5>
                            <div class="d-grid gap-2">
                                <a href="{{ url_for('admin_edit_experiencia', experiencia_id=experiencia_id) }}" 
                                   class="btn btn-outline-primary btn-sm">
                                    Editar
                                </a>
                                <form action="{{ url_for('admin_delete_experiencia', experiencia_id=experiencia_id) }}" 
                                      method="POST" class="d-grid"
                                      onsubmit="return confirm('¿Eliminar experiencia?');">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        Eliminar
                                    </button>
                                </form>
                            </div>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div> 

    </div> 

    {% else %}
    <div class="text-center py-5">
        <h2>Experiencia no encontrada</h2>
        <a href="{{ url_for('home') }}" class="btn btn-primary mt-3">Volver al Inicio</a>
    </div>
    {% endif %}

</div>
{% endblock %}