{% extends "base.html" %}
{% block title %}{{ experiencia.nombre }}{% endblock %}

{% block styles %}
<style>
  .experiencia-imagen {
    height: 500px;
    object-fit: cover;
    border-radius: 15px;
  }
  .sidebar-reservas { position: sticky; top: 100px; }
  .precio-tag {
    font-size:1.8rem; font-weight:700; color:var(--greenway-primary);
  }
  .btn-reservar {
    background-color:var(--greenway-accent);
    color:white;
    border:none;
    padding:12px 25px;
    font-size:1.1rem;
    font-weight:600;
  }
  .btn-reservar:hover { background:#00a2ff; }
</style>
{% endblock %}

{% block content %}
<div class="container my-5">
{% if experiencia %}

  <h1 class="display-5 fw-bold mb-4">{{ experiencia.nombre }}</h1>

  <div class="row g-5">

    <!-- IMÁGENES -->
    <div class="col-lg-8">

      <div id="carouselExperiencia" class="carousel slide shadow-sm mb-4">
        <div class="carousel-indicators">
          {% for img in experiencia.imagenes %}
          <button type="button" data-bs-target="#carouselExperiencia" data-bs-slide-to="{{ loop.index0 }}" 
                  class="{{ 'active' if loop.first else '' }}"></button>
          {% endfor %}
        </div>

        <div class="carousel-inner" style="border-radius: 15px;">
          {% for img_url in experiencia.imagenes %}
          <div class="carousel-item {{ 'active' if loop.first else '' }}">
            <img src="{{ img_url }}" class="d-block w-100 experiencia-imagen">
          </div>
          {% endfor %}
        </div>

        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExperiencia" data-bs-slide="prev">
          <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExperiencia" data-bs-slide="next">
          <span class="carousel-control-next-icon"></span>
        </button>
      </div>

      <hr class="my-4">
      <h2 class="fw-bold">Descripción</h2>
      <p class="fs-5" style="white-space: pre-wrap;">{{ experiencia.descripcion }}</p>

      {% if experiencia.maps_embed_url %}
      <hr class="my-4">
      <h2 class="fw-bold">Ubicación</h2>
      <div class="ratio ratio-16x9" style="border-radius:15px; overflow:hidden;">
        {{ experiencia.maps_embed_url|safe }}
      </div>
      {% endif %}

    </div>

    <!-- SIDEBAR -->
    <div class="col-lg-4">
      <div class="sidebar-reservas">
        <div class="card shadow-sm">
          <div class="card-body p-4">

            <div class="d-flex justify-content-between align-items-center mb-3">
              <span class="precio-tag">${{ "{:,.0f}".format(experiencia.precio_noche) }} COP</span>
              <span class="text-muted">por noche</span>
            </div>

            {% set wpp_number = '573001234567' %}
            <a href="https://wa.me/{{ wpp_number }}?text={{ ('Hola, estoy interesado en reservar: ' ~ experiencia.nombre)|urlencode }}"
               class="btn btn-reservar w-100">Reservar por WhatsApp</a>

            <a href="{{ url_for('chats') }}?owner_id={{ experiencia.propietario_id }}&exp_id={{ experiencia_id }}&initial_text={{ ('Hola, estoy interesado en la experiencia: ' ~ experiencia.nombre)|urlencode }}"
               class="btn btn-outline-success w-100 mt-2">
               Chatear con el propietario
            </a>

            {% if session['role'] == 'admin' or experiencia.propietario_id == session['user_id'] %}
            <hr class="my-4">
            <h5 class="text-muted">Panel de Propietario</h5>
            <div class="d-grid gap-2">
              <a href="{{ url_for('admin_edit_experiencia', experiencia_id=experiencia_id) }}" class="btn btn-outline-primary">
                Editar
              </a>

              <form action="{{ url_for('admin_delete_experiencia', experiencia_id=experiencia_id) }}" method="POST"
                    onsubmit="return confirm('¿Eliminar experiencia?');">
                <button class="btn btn-outline-danger">Eliminar</button>
              </form>
            </div>
            {% endif %}

          </div>
        </div>
      </div>
    </div>

  </div>

{% else %}
  <div class="text-center">
    <h2>Oops!</h2>
    <p>La experiencia no existe.</p>
    <a href="{{ url_for('home') }}" class="btn btn-primary">Volver al inicio</a>
  </div>
{% endif %}
</div>
{% endblock %}
