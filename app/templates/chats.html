{% extends "base.html" %}
{% block title %}Chats{% endblock %}

{% block styles %}
<style>
  .chat-shell { height: calc(100vh - 160px); display:flex; gap:20px; margin-top:20px; }
  .left-list { width:360px; background:#ffffff; color:#222; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:12px; overflow:auto; }
  .chat-panel { flex:1; background:#ffffff; color:#222; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.08); display:flex; flex-direction:column; overflow:hidden; }
  .messages { flex:1; padding:20px; overflow-y:auto; display:flex; flex-direction:column; gap:14px; }
  .msg { max-width:70%; padding:12px 16px; border-radius:14px; font-size:0.95rem; line-height:1.3; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
  .msg.me { background:#e7fbe6; color:#222; align-self:flex-end; border-bottom-right-radius:4px; }
  .msg.other { background:#d9f2ff; color:#222; align-self:flex-start; border-bottom-left-radius:4px; }
  .composer { display:flex; gap:10px; padding:14px; border-top:1px solid #e0e0e0; background:#fafafa; }
  .composer input { flex:1; padding:12px 16px; border-radius:20px; border:1px solid #ccc; background:white; color:#222; }
  .composer input:focus { outline:none; border-color:var(--greenway-accent); box-shadow:0 0 0 2px rgba(0,183,255,0.3); }
  .composer button { background:var(--greenway-accent); color:white; border:none; padding:12px 20px; border-radius:12px; font-weight:600; cursor:pointer;}
  
  .chat-item {
      display: flex; align-items: center; gap: 10px;
      padding: 10px; border-radius: 8px; cursor: pointer;
      transition: background 0.2s; border-bottom: 1px solid #eee;
  }
  .chat-item:hover { background: #f5f5f5; }
  .chat-item.active { background: #e3f2fd; }
  
  .preview-text {
      font-size: 0.8rem;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="chat-shell mx-auto">

    <div class="left-list">
      <h5 class="mb-3" style="font-weight:700;">Tus Conversaciones</h5>
      <div id="chat-list-container">
          <p class="text-center text-muted mt-4"><small>Cargando chats...</small></p>
      </div>
    </div>

    <div class="chat-panel">
      <div style="padding:16px 20px; border-bottom:1px solid #e0e0e0; font-weight:700;">
        {% if owner_name %} 
            Chat con: <span class="text-primary">{{ owner_name }}</span>
        {% else %} 
            Selecciona un chat 
        {% endif %}
      </div>

      <div id="messages" class="messages">
        {% if not room_id %}
            <div class="text-center text-muted mt-5">
                <i class="bi bi-chat-dots fs-1"></i>
                <p>Selecciona una conversación a la izquierda para empezar.</p>
            </div>
        {% endif %}
      </div>

      {% if room_id %}
      <div class="composer">
        <input id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off">
        <button id="sendBtn">Enviar</button>
      </div>
      {% endif %}
    </div>

  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCvNgRDVftYYYOO4NntYy6yjo9hUOrH_CU",
    authDomain: "greenway-450aa.firebaseapp.com",
    databaseURL: "https://greenway-450aa-default-rtdb.firebaseio.com",
    projectId: "greenway-450aa",
    storageBucket: "greenway-450aa.firebasestorage.app",
    messagingSenderId: "107049448583",
    appId: "1:107049448583:web:2f8a6eece8d2e21d913422"
  };

  if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
  }
  const db = firebase.database();

  const ROOM_ID = "{{ room_id }}"; 
  const MY_USER_ID = "{{ session.user_id }}";
  // Usamos el nombre de la sesión si existe
  const MY_NAME = "{{ session.user_email.split('@')[0] if session.user_email else 'Usuario' }}";

  const messagesDiv = document.getElementById('messages');
  const msgInput = document.getElementById('msgInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatListContainer = document.getElementById('chat-list-container');

  // --- FUNCIÓN MEJORADA PARA OBTENER DATOS DEL USUARIO (NOMBRE Y FOTO) ---
  async function getUserData(userId, nameElementId, imgElementId) {
      const nameEl = document.getElementById(nameElementId);
      const imgEl = document.getElementById(imgElementId);
      
      // Helper para procesar los datos si se encuentra el usuario
      const processUserData = (userData) => {
          nameEl.innerText = userData.nombre;
          if (userData.foto_url) {
              imgEl.src = userData.foto_url;
          }
          // Si no tiene foto_url, se queda con el avatar por defecto que ya pusimos en el HTML
      };

      // 1. Buscar en propietarios
      db.ref('propietarios/' + userId).once('value').then(snap => {
          if (snap.exists()) {
              processUserData(snap.val());
          } else {
              // 2. Si no, buscar en usuarios
              db.ref('usuarios/' + userId).once('value').then(snap2 => {
                  if (snap2.exists()) {
                      processUserData(snap2.val());
                  } else {
                      nameEl.innerText = "Usuario Desconocido";
                  }
              });
          }
      });
  }

  // --- LISTAR CHATS ---
  db.ref('chats').on('value', (snapshot) => {
      chatListContainer.innerHTML = ""; 
      const allChats = snapshot.val();

      if (!allChats) {
          chatListContainer.innerHTML = "<p class='text-muted small'>No tienes chats aún.</p>";
          return;
      }

      let foundAny = false;

      Object.keys(allChats).forEach(key => {
          if (key.includes(MY_USER_ID)) {
              foundAny = true;
              
              const parts = key.split('_');
              const expId = parts[1];
              const userA = parts[2];
              const userB = parts[3];

              let otherUserId = (userA === MY_USER_ID) ? userB : userA;
              
              // IDs únicos para los elementos HTML de este chat
              const nameSpanId = `name-${key}`; 
              const imgId = `img-${key}`;

              // --- LÓGICA ÚLTIMO MENSAJE (Igual que antes) ---
              let previewText = "<i>Escribe el primer mensaje...</i>";
              const chatData = allChats[key];
              if (chatData.messages) {
                  const msgsArray = Object.values(chatData.messages);
                  msgsArray.sort((a, b) => a.timestamp - b.timestamp);
                  const lastMsg = msgsArray[msgsArray.length - 1];
                  if (lastMsg.text.length > 25) {
                      previewText = lastMsg.text.substring(0, 25) + "...";
                  } else {
                      previewText = lastMsg.text;
                  }
                  if (lastMsg.sender_id === MY_USER_ID) {
                      previewText = "<strong>Tú:</strong> " + previewText;
                  }
              }
              // -----------------------------------------------

              const div = document.createElement('div');
              const isActive = (key === ROOM_ID) ? 'active' : '';
              div.className = `chat-item ${isActive}`;
              // Ponemos un avatar por defecto inicial con el ID, luego JS lo actualiza si encuentra foto real
              div.innerHTML = `
                  <img id="${imgId}" src="https://ui-avatars.com/api/?name=${otherUserId}&background=random" 
                       style="width:40px;height:40px;border-radius:50%; object-fit:cover;">
                  <div style="overflow:hidden; flex:1;">
                      <div style="font-weight:bold;font-size:0.9rem;">
                        <span id="${nameSpanId}">Cargando...</span>
                      </div>
                      <div class="preview-text">${previewText}</div>
                  </div>
              `;

              div.onclick = () => {
                  window.location.href = `/chats?owner_id=${otherUserId}&exp_id=${expId}`;
              };

              chatListContainer.appendChild(div);
              
              // Llamamos a la función mejorada para buscar nombre Y foto
              getUserData(otherUserId, nameSpanId, imgId);
          }
      });

      if (!foundAny) {
          chatListContainer.innerHTML = "<p class='text-muted small p-2'>No participas en ningún chat todavía.</p>";
      }
  });

  // --- LOGICA DE MENSAJES (DERECHA) ---
  function sendMessage() {
    const text = msgInput.value.trim();
    if (!text) return;

    // NOTA IMPORTANTE: Aquí idealmente deberíamos enviar el nombre real actualizado desde la DB,
    // no el de la sesión que puede estar viejo. Pero para este MVP está bien así.
    db.ref('chats/' + ROOM_ID + '/messages').push({
      sender_id: MY_USER_ID,
      sender_name: MY_NAME, 
      text: text,
      timestamp: firebase.database.ServerValue.TIMESTAMP
    });

    msgInput.value = ""; 
  }

  function renderMessage(msg) {
    const div = document.createElement('div');
    const isMe = (msg.sender_id === MY_USER_ID);
    div.className = 'msg ' + (isMe ? 'me' : 'other');
    
    const date = new Date(msg.timestamp);
    const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:baseline;">
          <small style="font-weight:bold; font-size:0.8rem; margin-right:8px;">${msg.sender_name}</small>
          <small style="font-size:0.65rem; opacity:0.7;">${timeStr}</small>
      </div>
      ${msg.text}
    `;
    
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  if (ROOM_ID && ROOM_ID !== "None") {
    db.ref('chats/' + ROOM_ID + '/messages').orderByChild('timestamp').on('child_added', (snapshot) => {
      const data = snapshot.val();
      renderMessage(data);
    });

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  }
</script>
{% endblock %}