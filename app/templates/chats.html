{% extends "base.html" %}
{% block title %}Chats{% endblock %}

{% block styles %}
<style>
  /* CONTENEDOR GENERAL */
  .chat-shell { 
    height: calc(100vh - 160px); 
    display:flex; 
    gap:20px; 
    margin-top:20px; 
  }

  /* LISTA IZQUIERDA */
  .left-list {
    width:360px;
    background:#ffffff;
    color:#222;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    padding:12px;
    overflow:auto;
  }

  /* PANEL DEL CHAT */
  .chat-panel {
    flex:1;
    background:#ffffff;
    color:#222;
    border-radius:12px;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    display:flex;
    flex-direction:column;
    overflow:hidden; 
  }

  /* LISTA DE MENSAJES */
  .messages {
    flex:1;
    padding:20px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:14px;
  }

  /* MENSAJES */
  .msg {
    max-width:70%;
    padding:12px 16px;
    border-radius:14px;
    font-size:0.95rem;
    line-height:1.3;
    box-shadow:0 1px 4px rgba(0,0,0,0.08);
  }

  .msg.me {
    background:#e7fbe6;
    color:#222;
    align-self:flex-end;
    border-bottom-right-radius:4px;
  }

  .msg.other {
    background:#d9f2ff;
    color:#222;
    align-self:flex-start;
    border-bottom-left-radius:4px;
  }

  /* ESCRITORIO */
  .composer {
    display:flex;
    gap:10px;
    padding:14px;
    border-top:1px solid #e0e0e0;
    background:#fafafa;
  }

  .composer input {
    flex:1;
    padding:12px 16px;
    border-radius:20px;
    border:1px solid #ccc;
    background:white;
    color:#222;
  }

  .composer input:focus {
    outline:none;
    border-color:var(--greenway-accent);
    box-shadow:0 0 0 2px rgba(0,183,255,0.3);
  }

  .composer button {
    background:var(--greenway-accent);
    color:white;
    border:none;
    padding:12px 20px;
    border-radius:12px;
    font-weight:600;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="chat-shell mx-auto">

    <!-- LISTA IZQUIERDA -->
    <div class="left-list">
      <h5 class="mb-3" style="font-weight:700;">Conversaciones</h5>

      {% if owner_id %}
      <div class="d-flex align-items-center gap-2 p-2" style="border-radius:8px;background:#f3f3f3;">
        <img src="https://i.pravatar.cc/100?u={{ owner_id }}" 
             style="width:48px;height:48px;border-radius:50%;object-fit:cover;">
        <div>
          <div style="font-weight:700;">Propietario</div>
          <small class="text-muted">ID: {{ owner_id }}</small>
        </div>
      </div>
      {% else %}
      <p class="text-muted">Selecciona una experiencia para chatear con su propietario.</p>
      {% endif %}
    </div>

    <!-- CHAT PRINCIPAL -->
    <div class="chat-panel">

      <div style="padding:16px 20px; border-bottom:1px solid #e0e0e0; font-weight:700;">
        {% if owner_id %} Chat con el propietario: {{ owner_id }} {% else %} Mensajes {% endif %}
      </div>

      <div id="messages" class="messages">
        {% for m in messages %}
          {% if m.sender_id == session.user_id %}
            <div class="msg me">
              <strong>{{ m.sender_name }}</strong><br>{{ m.text }}
            </div>
          {% else %}
            <div class="msg other">
              <strong>{{ m.sender_name }}</strong><br>{{ m.text }}
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <div class="composer">
        <input id="msgInput" placeholder="Escribe un mensaje..." autocomplete="off">
        <button id="sendBtn">Enviar</button>
      </div>

    </div>
  </div>
</div>

<!-- SOCKET.IO -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
(function(){

    // ⚠️ CAMBIA ESTA URL POR TU BACKEND EN RENDER ⚠️
    const socket = io("https://greenway-project.onrender.com", {
        transports: ["websocket"],
        withCredentials: true
    });

    const room = "{{ room_id }}";
    const expId = "{{ exp_id }}";
    const initialText = `{{ initial_text|e }}`;

    const senderId = "{{ session.user_id }}";
    const senderName = "{{ session.user_email.split('@')[0] if session.user_email else 'Usuario' }}";

    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    function appendMessage(obj) {
      const div = document.createElement('div');
      div.className = 'msg ' + (obj.sender_id == senderId ? 'me' : 'other');
      div.innerHTML = `<strong>${obj.sender_name}</strong><br>${obj.text}`;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    socket.on("connect", () => {
        if (room) {
            socket.emit("join", {
                room: room,
                user_id: senderId,
                display_name: senderName
            });
        }

        if (initialText && room) {
            socket.emit("send_message", {
                room: room,
                sender_id: senderId,
                sender_name: senderName,
                text: initialText,
                exp_id: expId
            });
        }
    });

    socket.on("new_message", appendMessage);

    sendBtn.addEventListener("click", () => {
        const text = inputEl.value.trim();
        if (!text || !room) return;

        socket.emit("send_message", {
            room: room,
            sender_id: senderId,
            sender_name: senderName,
            text: text,
            exp_id: expId
        });

        inputEl.value = "";
    });

    inputEl.addEventListener("keypress", e => {
        if (e.key === "Enter") sendBtn.click();
    });

})();
</script>

{% endblock %}